{% comment %}
  Social Family Custom - Instagram-style social content showcase

  Features:
  - Horizontal scrolling gallery with center-focused scaling
  - Image and video support
  - Product tagging with quick-add functionality
  - Expandable product panel
  - Drag scroll
  - Navigation arrows
  - Instagram-style design
{% endcomment %}

<section class="py-12 md:py-20 bg-white overflow-hidden select-none relative"
         data-social-family>

  {%- comment -%} Section Title {%- endcomment -%}
  <div class="max-w-[var(--custom-container-max-width)] mx-auto px-6 mb-8 md:mb-12">
    {%- if section.settings.title != blank -%}
      <h2 class="text-[24px] md:text-[36px] font-black text-[#1a1a1a] tracking-tight leading-[1.1]"
          style="font-family: var(--font-heading-family);">
        {{ section.settings.title }}
      </h2>
    {%- endif -%}
  </div>

  {%- comment -%} Gallery Container {%- endcomment -%}
  <div class="relative group">

    {%- comment -%} Left Navigation Arrow {%- endcomment -%}
    <button class="hidden lg:flex absolute left-8 top-1/2 -translate-y-1/2 z-40 w-14 h-14 bg-white/90 backdrop-blur-md rounded-full items-center justify-center shadow-2xl border border-gray-100 hover:scale-110 active:scale-95 transition-all text-[#1a1a1a] opacity-0 group-hover:opacity-100"
            data-scroll-direction="left"
            aria-label="Scroll left">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path>
      </svg>
    </button>

    {%- comment -%} Right Navigation Arrow {%- endcomment -%}
    <button class="hidden lg:flex absolute right-8 top-1/2 -translate-y-1/2 z-40 w-14 h-14 bg-white/90 backdrop-blur-md rounded-full items-center justify-center shadow-2xl border border-gray-100 hover:scale-110 active:scale-95 transition-all text-[#1a1a1a] opacity-0 group-hover:opacity-100"
            data-scroll-direction="right"
            aria-label="Scroll right">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"></path>
      </svg>
    </button>

    {%- comment -%} Scroll Container {%- endcomment -%}
    <div class="flex overflow-x-auto custom-hide-scrollbar snap-x snap-mandatory px-[17vw] md:px-12 gap-4 md:gap-8 pb-2 md:pb-14 items-end cursor-grab"
         data-social-scroll
         data-drag-scroll>

      {%- comment -%} Moments Loop {%- endcomment -%}
      {%- for block in section.blocks -%}
        {%- liquid
          assign media_type = block.settings.media_type
          assign image = block.settings.image
          assign video = block.settings.video
          assign video_poster = block.settings.video_poster

          # Get products from block settings (up to 3 products)
          assign product_1 = all_products[block.settings.product_1]
          assign product_2 = all_products[block.settings.product_2]
          assign product_3 = all_products[block.settings.product_3]

          assign products_array = ''
          assign product_count = 0

          if product_1.id
            assign products_array = products_array | append: product_1.id
            assign product_count = product_count | plus: 1
          endif

          if product_2.id
            if product_count > 0
              assign products_array = products_array | append: ','
            endif
            assign products_array = products_array | append: product_2.id
            assign product_count = product_count | plus: 1
          endif

          if product_3.id
            if product_count > 0
              assign products_array = products_array | append: ','
            endif
            assign products_array = products_array | append: product_3.id
            assign product_count = product_count | plus: 1
          endif
        -%}

        <div class="flex-shrink-0 w-[66vw] sm:w-[320px] md:w-[480px] snap-center transition-all duration-500 ease-out will-change-transform flex flex-col items-center social-moment"
             data-moment-index="{{ forloop.index0 }}"
             {{ block.shopify_attributes }}>

          <div class="relative w-full aspect-[3/4] md:aspect-square rounded-[2.2rem] md:rounded-[3rem] overflow-hidden bg-white shadow-[0_15px_45px_rgba(0,0,0,0.08)] border border-gray-100">

            {%- comment -%} Media (Image or Video) {%- endcomment -%}
            {%- if media_type == 'video' and video != blank -%}
              <video src="{{ video }}"
                     {% if video_poster != blank %}poster="{{ video_poster | image_url: width: 1000 }}"{% endif %}
                     class="w-full h-full object-cover"
                     muted
                     loop
                     playsinline
                     autoplay>
              </video>
            {%- elsif image != blank -%}
              <img src="{{ image | image_url: width: 1000 }}"
                   srcset="{{ image | image_url: width: 500 }} 500w,
                           {{ image | image_url: width: 1000 }} 1000w"
                   sizes="(min-width: 768px) 480px, 66vw"
                   class="w-full h-full object-cover"
                   alt="{{ block.settings.alt_text | escape }}"
                   loading="lazy"
              />
            {%- else -%}
              {%- comment -%} Placeholder {%- endcomment -%}
              <div class="w-full h-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center">
                <svg class="w-20 h-20 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                </svg>
              </div>
            {%- endif -%}

            {%- comment -%} Product Tag Card (First Product) {%- endcomment -%}
            {%- if product_1.id and section.settings.show_product_tags -%}
              <div class="absolute bottom-6 left-1/2 -translate-x-1/2 w-[92%] pointer-events-auto">
                <div class="bg-white/95 backdrop-blur-md rounded-[2rem] md:rounded-[2.5rem] p-2 md:p-3 shadow-2xl border border-white/50 flex items-center justify-between">

                  <div class="flex items-center gap-2 md:gap-4 flex-1 min-w-0">
                    {%- if product_1.featured_image -%}
                      <div class="w-10 h-10 md:w-16 md:h-16 bg-white rounded-2xl p-1.5 flex items-center justify-center flex-shrink-0 border border-gray-100">
                        <img src="{{ product_1.featured_image | image_url: width: 100 }}"
                             alt="{{ product_1.title | escape }}"
                             class="max-w-full max-h-full object-contain"
                        />
                      </div>
                    {%- endif -%}

                    <div class="flex flex-col min-w-0">
                      <h4 class="text-[11px] md:text-[14px] font-bold text-[#1a1a1a] truncate leading-tight">
                        {{ product_1.title }}
                      </h4>
                      <div class="flex items-baseline gap-1.5 mt-0.5">
                        <span class="text-[13px] md:text-[18px] font-black text-[#1a1a1a]">
                          {{ product_1.price | money }}
                        </span>
                        {%- if product_1.compare_at_price > product_1.price -%}
                          <span class="text-[9px] md:text-[12px] text-gray-300 line-through font-bold">
                            {{ product_1.compare_at_price | money }}
                          </span>
                        {%- endif -%}
                      </div>
                    </div>
                  </div>

                  <div class="flex gap-2 ml-2">
                    {%- if section.settings.enable_quick_add -%}
                      <button class="w-8 h-8 md:w-11 md:h-11 rounded-full border border-gray-100 flex items-center justify-center hover:bg-gray-50 transition-all active:scale-90 bg-white shadow-sm quick-add-btn"
                              data-product-id="{{ product_1.variants.first.id }}"
                              aria-label="Add {{ product_1.title }} to cart">
                        <svg class="w-4 h-4 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                          <path d="M12 4.5v15m7.5-7.5h-15"></path>
                        </svg>
                      </button>
                    {%- endif -%}

                    {%- if product_count > 1 -%}
                      <button class="w-8 h-8 md:w-11 md:h-11 rounded-full border border-gray-100 flex items-center justify-center hover:bg-gray-100 transition-all active:scale-90 bg-white shadow-sm expand-btn"
                              data-expand-target="expand-{{ forloop.index0 }}"
                              aria-label="Show all products">
                        <svg class="w-4 h-4 text-gray-800 expand-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7"></path>
                        </svg>
                      </button>
                    {%- endif -%}
                  </div>
                </div>
              </div>
            {%- endif -%}

            {%- comment -%} Expanded Product Panel {%- endcomment -%}
            {%- if product_count > 1 and section.settings.show_product_tags -%}
              <div class="absolute inset-0 bg-white/98 backdrop-blur-xl transition-all duration-500 transform cursor-pointer z-50 translate-y-full opacity-0 expand-panel"
                   id="expand-{{ forloop.index0 }}">
                <div class="h-full flex flex-col p-5 md:p-12 overflow-hidden">

                  <div class="flex items-center justify-between mb-6 md:mb-10">
                    <h3 class="text-[20px] md:text-[32px] font-black text-[#1a1a1a] tracking-tight leading-none">
                      Products In This Post
                    </h3>
                    <button class="p-2.5 md:p-3 bg-gray-50 rounded-full hover:bg-gray-100 transition-all close-expand-btn"
                            aria-label="Close">
                      <svg class="w-5 h-5 md:w-7 md:h-7 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path>
                      </svg>
                    </button>
                  </div>

                  <div class="flex-1 overflow-y-auto space-y-4 md:space-y-6 custom-hide-scrollbar flex flex-col items-center">
                    {%- if product_1.id -%}
                      {%- render 'social-product-card', product: product_1, enable_quick_add: section.settings.enable_quick_add -%}
                    {%- endif -%}
                    {%- if product_2.id -%}
                      {%- render 'social-product-card', product: product_2, enable_quick_add: section.settings.enable_quick_add -%}
                    {%- endif -%}
                    {%- if product_3.id -%}
                      {%- render 'social-product-card', product: product_3, enable_quick_add: section.settings.enable_quick_add -%}
                    {%- endif -%}
                    <div class="h-20 w-full flex-shrink-0"></div>
                  </div>
                </div>
              </div>
            {%- endif -%}
          </div>
        </div>

      {%- endfor -%}

      {%- if section.blocks.size == 0 -%}
        <div class="w-full text-center py-12 px-6 text-gray-500">
          <p class="text-lg font-bold mb-2">No moments yet</p>
          <p class="text-sm">Add image/video blocks in the theme customizer.</p>
        </div>
      {%- endif -%}
    </div>
  </div>

  {%- comment -%} CTA Button {%- endcomment -%}
  {%- if section.settings.show_cta_button and section.settings.cta_text != blank -%}
    <div class="flex justify-center mt-6 md:mt-16 px-6">
      <a href="{{ section.settings.cta_link | default: section.settings.instagram_link | default: '#' }}"
         class="w-full md:w-auto bg-[var(--custom-color-primary)] text-white px-16 py-4 md:py-5 rounded-full font-black text-[13px] md:text-sm tracking-[0.15em] hover:bg-[var(--custom-color-primary-dark)] transition-all shadow-xl uppercase active:scale-95"
         {% if section.settings.cta_link == blank %}aria-disabled="true"{% endif %}>
        {{ section.settings.cta_text }}
      </a>
    </div>
  {%- endif -%}
</section>

{%- comment -%} Load JavaScript {%- endcomment -%}
<script src="{{ 'custom-social.js' | asset_url }}" defer="defer"></script>

{% schema %}
{
  "name": "Social Family Custom",
  "tag": "section",
  "class": "social-family-custom-section",
  "settings": [
    {
      "type": "header",
      "content": "Section Settings"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Section title",
      "default": "Welcome to the ONESPORT Family"
    },
    {
      "type": "checkbox",
      "id": "show_product_tags",
      "label": "Show product tags",
      "default": true,
      "info": "Display product cards on images"
    },
    {
      "type": "checkbox",
      "id": "enable_quick_add",
      "label": "Enable quick add to cart",
      "default": true,
      "info": "Allow adding products directly from the gallery"
    },
    {
      "type": "header",
      "content": "Call-to-Action"
    },
    {
      "type": "checkbox",
      "id": "show_cta_button",
      "label": "Show CTA button",
      "default": true
    },
    {
      "type": "text",
      "id": "cta_text",
      "label": "Button text",
      "default": "Upload your cycling moments"
    },
    {
      "type": "url",
      "id": "cta_link",
      "label": "Button link"
    },
    {
      "type": "url",
      "id": "instagram_link",
      "label": "Instagram link (fallback)",
      "info": "Used if button link is not set"
    }
  ],
  "blocks": [
    {
      "type": "moment",
      "name": "Moment",
      "limit": 20,
      "settings": [
        {
          "type": "header",
          "content": "Media"
        },
        {
          "type": "select",
          "id": "media_type",
          "label": "Media type",
          "options": [
            {
              "value": "image",
              "label": "Image"
            },
            {
              "value": "video",
              "label": "Video"
            }
          ],
          "default": "image"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image",
          "info": "Used when media type is Image"
        },
        {
          "type": "video",
          "id": "video",
          "label": "Video file",
          "info": "Used when media type is Video"
        },
        {
          "type": "image_picker",
          "id": "video_poster",
          "label": "Video poster image (optional)"
        },
        {
          "type": "text",
          "id": "alt_text",
          "label": "Alt text"
        },
        {
          "type": "header",
          "content": "Tagged Products (up to 3)"
        },
        {
          "type": "product",
          "id": "product_1",
          "label": "Product 1",
          "info": "First product (shown on the card)"
        },
        {
          "type": "product",
          "id": "product_2",
          "label": "Product 2 (optional)",
          "info": "Shown in expanded view"
        },
        {
          "type": "product",
          "id": "product_3",
          "label": "Product 3 (optional)",
          "info": "Shown in expanded view"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Social Family Custom",
      "settings": {
        "title": "Welcome to the ONESPORT Family",
        "show_product_tags": true,
        "enable_quick_add": true,
        "show_cta_button": true,
        "cta_text": "Upload your cycling moments"
      }
    }
  ]
}
{% endschema %}
